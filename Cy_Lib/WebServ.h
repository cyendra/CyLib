

/*******************************



	             v@GXMi                                                                                                                                   
              7@B00U                               ..                                                                                                 
               .@BMM@E.           i         . ... .,;r;:                                                                                              
Mk:              0B@0M@J          Y   .:::::::..        :                                                                                             
.M@BBXJi.         uBM0OBS        r. .::::..      ......                                                                                               
  B@8MB@@@8Fi.     @BMGOBr      :: ,::,.   ..,::::,,...:ii:.                      :u                                                                  
   MBq0XEEOM@BZr,  B@OB8MB    .:,.::,...,::,:....  .::::::ii7;.                   Si      .iiiii:                                                     
    BOXPXPkPXOB@@@E@MMOBM@;  ::.,:,..,....       .,:::..      i                  ,F      J7,   .iU.  i,                                               
    .BZkXFkFEB@BBB@BMB@B@B: i: ::,:::..     ,:rvJ77riiiii::,,...                 ui     2r       :X  75       7                                       
     LBEXEGMBBMMMMM@B@iBB@ :: :iii:, . ..:rJ2FULri:i::,,,:,::iivL:              :E      E        r2   k.    :2i  :1:i7.                               
      PBMB@E@B@B@MB@@;  @@vi i7r:.   .irYYvi:..     ........ririi7vi,.          .:i;v   ru.     rU    77  .Y7    U:                                   
       rB0  .iv0B@@@M   LOr.r7:.  ,7jUjLi,   . ..........  .7UJvvvi;iri::,               .rrirr7:      X rv.    .k::,                                 
             ..:v1BBM    jr7r  .:vuL7:,     . .....    .:ii:::vvrrv7:,,.,,i:,                          Y2,      j:  .                                 
       .      .L.::YEi::.2Li.:7JL7:,    .......... ... ,,irYuLirL7,,ir:.,. .:7.                                .0:                                    
      ;,,.. .:Y5     7XJqJ1,irr,.     . ......:,,..  .:irL1uujYrirL:.:v. ii   i.                                .,ir,                                 
     .r.  .::iiL7  rvuv:  7Lu:    .,.:,,,,..      .,:vuSP022uvLY;::vr.,U  .r.  :.                                                                     
     ., :vu7: . .r:jjui   jUjiii.   ....,,:ru7;:i777LLu51ri:,..7uLr:rv,.v   vv:                          ii                                           
      : PXLjuX81,  .5jr,:7u, :.kB7r;::...   .r7i:ir7irJ57.   FOZL22uri7:.r   ,i                          E:      L:  .                                
      :,jU5FN7:2:  Li  uBv.  :  E,.,iirii75UUJu12i.    ,  .:@BS   riuLii. :   .:                        ;u      .E   uL       .                       
       :LJ7v   iriiYi  7ui.: :  :r             ,:jUi       5@5J  .   uk:,...   ,:                       F.      v7   .S      LJ  .v::i                
        .LL.  .7EN5SU. 77.rv.,   ::          ,             .S5@F  .   ku.,.     :.                     rS       q     1:   iU:   L7  .   :L           
         2NPE@B@@ LLv1rqu7i;... .ii.       7j.               :v:  ,.   uv :      :                     iriii   jj     :5 .Lr     P.      P:           
      ,k@BB@@O@B  :v, :M7  i: ,.r7v.     ,E7                     ::.    v.;.    7:     ri.                 .   i.      5ur      77.::   ;L            
    ,OBMqPqEEOBq   7   @u  .7  i:rLi    rq                           .  ,r7:    ,;i   ir..                             :,      .N       r             
   5@M0kqNEEZ8@   UBF  Bq .:N7.i7r7Y:  :7      :uUi           ...       .,;,rii :: .  r: .,                                    .7irr.  :.             
  M@NPSqGZEZqM: u@BMBB:@B  iv0;:r7rrv  ,     :8@k.                       .i     7: i .;  ,.:                                       .   ;.             
YZOkP508Z00P0NZB@MEq8B@B@r :;75iirr:i7:     7B@F.                         ,     Y  i ,;  ..j:                                                         
B@852ZOZqNqNq08MO0PqPOOOBM  iijuiii:,i7.    B@L5u, i:                    ..     L  r :,    r:   ..:.                                   .:i::.,,:,,... 
ZE@BMB8q0PNP00MMGXqXPEO8M@L :iiJ7::::,:r:  i@N7u@8. :             :LU.   :      r  r :.    ii  :.,i                               ,ruFFY7:.         ..
B@@@B@MEqqXNPOOMPqPqXNGOGBB7,:,ivr::::,,i:  k@r,:,  ,:.         .ii::.   :     .:  r::  i  r.   .i                             :LkSui.                
@u:   @BEqqX88MOXPNXXkGZ8ZBM7ii,:vi::,,,,..  :i,.  .:   .      ii,,,.   :      ir  72i  r .Y  . i                           ,LFj7,                    
       OB0kGM8MGFqXqXkq8E8ZMN7;r.:0v,:,,.,...  .     ...      ir,:..    :      Li  .ki  1  Zi: i                         .iY7:                        
        2BGMOG@8EqqXqkqEGZ8MMZSY7,r@Sr:::::..   ,::,:.   :.    .       L:::,  i:i   .   .  ir .;                      :iri.                           
         uB@88MOO8GZP0kEE8M0XP00L7:7qXYr:ii:::..     .,iv,           iFqi::;iii :.            .r                  .iri.                               
         5JNBO@BjiNPMM@EEME,;7ir77vr7UFuJ:iirii:::i:ii::         .Y7.i:     .ii.r,            ir              .:rri.                                  
        LL.rvMZS;iv;1:rMBMYviLL77v7v77JFu. .ivriri.i:,     .,::i:.2i     .     ,7,            i;          .:ir:,                                      
        @  v;r7rviiuu.  M5:JJrjL77v7777J2Uv.   .i:7YuNJ::::,:,,,. JBiiuMOur::                 :.     .,.,,:.             :i7uLYYJLJLJLjvri::.         
       5X  7vLLL2, EvF   M7ruJruLr7v7v77JjLFSFLYv7iLvLj:.::iii..,vLJLi:72ZXYruu,              ii.:..            .,:i;LukqqUvi,.      ..::;r7i:,.  ..  
      :Mr  rJLJ7X  UYS:   NrruJruJ7rv7777uYrLuFJYj,.Luiii::.  :iLv:         .,rU2i,.         .v 7G::v7;:iirr7vLLuu1Uuvr,                    .:r;:   . 
      SZ. .rJu7Ju  i1Uv   .FriJuruJr7v7v775Lr77UuJLYvuL    ,,:7rri.             .7L7r:    .i:.  FZ   rXOSujUuUJLri..                           ,ir:.. 
     vSF  :ruL;P:   kY1    :Xi;Y2rJu7777vrvk7r77LvLvYuS   ;7riir,i                 .iUL  :,     Ej     .1Fri:,.                                  .i::.
    .uUL .:7uvrS    ujS     7u:iv2vLj7rv7vrJq7r77vLuJvY .::i::ii.i                   .LM5r     i0i       .i    ..,,:::::..                         ::.
    jiq: .:vuijr    72S:     Ur:i7uYYjvrv77;UXrrvvjS   :i::,::r.::                    7LJSOOZUiLX:        iv..... .   ..::iii:.                     ,.
   7rrS. ,:uviF     ,kU7     :qi:irYJuuLr777rFF77L    :v...:,r:,.:                    ,:   :irY1uSSL,      kr::::iiii::,..   .:iii,                   
  .u:7U  .iUiru      PU7      GJi:irvLu52rr77rXuvL:,. :r..,::i,,.:            .,:.     7r.    iF7 :vPF7    .@i::.   ..::;rrii,.   ,:r:                
  j;:LU  ,iU.Li      qU7      uk7i:i;77v2XYrrr7FLLki ::,..:.i::: ,           :,,,;     .::i.  FE    :q8Gj7: U7irii:.         ,:i::.  .i;.    .....    
  j:iJu ..vL.L       jkv      rF1ii:ii777vS5Yrr7jvF   ... :.r.:. ..        .:.. ::     .. .iiiMF .J0U:  i7u2MPr7vr7Lu7:.         ,7Li   7j:  ...,,::i.
 riiiF; ..L;:7       i0L      .5uu:i:iir7vrLu5v77jF    . ,.r:::.  .       .:... .       .     :8q@u          5Evi7rri7JXS5Lr7YL7rrirr;ri.,rr          
F:i:iF: ..L,r:       .OL       J7SL:r::i;rvv77JYLvF      ::7.,i   :.     .:.,..:.              uU.            .8uii:7i;ir7vi           .rr::Y:        
:.ii77.  :v.v         Zv       viYPiir:.ir;7vL77vJF      :ii.::   .r     i.....i.              i:,,.,,.        PPFY7ij:vvrivL7.          .:i:rv       
,,iiL.i .:7.Y         E;       r:rS5:r7:..rrr7Lvvvk     .:r,,:,    ,     .  ....:                .ir:,:.       8G1FF7v  :7Yv77uL:           ::rv.     
::i7: i  ii:r         S:       r,:LO::v7r. :77r7vLX.    .:i. .    .7B@kYr,   ...,                   i:,,.      ,58kFUj:    ivJvvYJ:           :rL.    
::iY  :  i:i:         L.       :;.;vY.rL7v:  :v77v1.     :i.:7u1OBBM05kqO@@Y.  .,.                   i,.:.       .S0FuY       :7jYuv:          ,jY    
::rv  i  ;.7          L        ,7.,v.L 7L7vv.  i7Ui,     ,B@BBMq2J77vLLuLuF@BO.  ,,..            .    ir:,.        S85F          :L2FL          .P5   
:,Y,  i .i.7          O         v..7 :: 7Jv7j7.  7...    :iM@LJ7r7v7YvLLUJYv5M@X,  .,,:,,,,..          .irri.       OZZ            .i2qi         :Ek  
::Y   i  i.7         .G         7..7. L .7Yv7LJv..  :   .i. G@2Yrv7LvL7vYUjjLLJM@X,  ..,.,....            .i7.       MB:              :qF         vSL 
:i7   :, :,r         vE         v..;: .; .rJL7vvuj  :   .::  0@Fvrv7v7v77JUJjJJv1M@Z.  ...,....             .i.      ,:                 r0:        U5,
:7,    r :,r         E1         r,.r:  :: .:JY7vLJ   :   :7,  S@k7rv7v7v77YUJuuuYLuMBk                        ii      .                   P7       vLv
:7     i .,i        7P;         i..ii   r,.:,7u7v2   ..  ::v,  U@Xr7vvLvvr7LujuJujuY2M@N.                     ,, ,.   :.                   u7      .Fi
r;     ., .;       ,uJ          ,: ii    ;..i.:jL5i      .,:Y,  L@Sr7JJY7v77LuYuJujUJYu@BP                    .r  i.   r                    7r      F;
Y,      :..i  ,    Ju.           : :r     i. :,.ru1,..    . ,Y.  r@XLJuYv7vrrvuYujujUujLZB@r                  .,. .:.  :,                    J,     uv
J.       :.i  r   rJ:            i ,i      :, ,;.:vkLv;i:iiL.,u.  :@OYuj7v77rrvjYujujUuuL1M@O.   .            .::     .,i                     2     7j
U.       :,,  v  ,J7             :..i       .7..i.:iu5FJju5XkrrN,  .@8uv7vL77rr7jJuuuJujuLYUZMOS7,             ..    .,.7                     ,2    vJ
7i        :.:i   77              .: i        i::,.  .rL1uJ777jvuOi   Z077Lvv77rr7JYUjuYujuYjJJUEB@BGL. ...           :..r.                     Sr   v1
,;         ,:r  :7.               ; i       :   ::i.   ,rYFSk22Lvk  1iBv77LvL7vrrrYJuuuJuJuJujuJJu8B@Mq:  ....      ,,,.7:                     ,M   8:
rr:       :F:r, ri                .:..     :.     .;r,     ,,,:vUiiOB0u0rvvLvL77rrrLjuuujuJujuuFXXv, .u@M:   ..... .,,..i                       O: LU 
  vSSYYJkEOr ,i:r                  ::.    ,          :ri.       @S@B@@78LrvvLvL7vrr;vJuuuuUukPP27,  ..  U@O:      ..,..i:                       Nr.:  
   .;j15Yi    ,7r,                  .,  ..             .iULr:.  B@B@B@SXN77v7LvLvLrrrvuFk0PSJr.. .,:,:.. .B@B0Uv:,.,,:i;                        XS    
              .rir:,.               .:;.                  .iLU5LOB5ir: L@L7vLLLLYLjJuYu1Yi:.  ..,,:,:,,,, XBq: .....,,.                        .EL    
              i  .i:.:,:,.      .,::.  i:                          i   .BGL5FXFFuuYv;:.. ....,,:,:,:,:::. i@1k                                 :N:    
              i    .i::,::::::i::,.     USr           :            i;:,,BEY7r:..7.. ....,,:,:,:,:,:.,,,   iBUq                                 7G     
             :.        . ... , r    ...  rk8Sr..     .i             :r.         ii.,,,,:,:,:,:,:,,....    :@uu:                                kS     
             u.              ,  L       :   ir7rrii::u:,,:i,                     7.,:,:,:::,,,,,.....     i@Urv                               :Oi     
             k              ..  :r    ::          ..,; .    ..                   :.:,:,:,:,:,,.... .      r@uiv                              .ZL      
             E              :    L  .7.                 .     .                  .:,:,:...,,,.. .         7BJ:L                             .Xv       
             M:            ..     vii                       .. .              : ,:::,::,......            J@7i7                            ,7:        
             k1            ,     .0i                           .,:i:          i :7,::,:::....             1B7;;                          .::          
             ;O.          .i    L7 L                              .uBk:     .... ii,,,.:::                S@.r,                                       
              P2         .@.  :U,  ,v                               .B@@@OS,  ::: :::.....,               EB7X.                                       
               Oi        P@  77     ;.                               OMGO@S .:::::,:::,.   .              MO7S.                                       
                E:      LBX ri  ... .7....... .                      L@EZG@. .:,:,:::::..                 @kiL:                                       
                 L:     O@Pr;,.:::::.ii,.,..........     SNqFur,      BMNE@k ..:...,,,,:,.                B2rrv                                       
                  ...    MMN7.,      :.                  B@MBB@B@M5:   BZNGBi .,,.......,.,              ,@7L:1                                       
                         MO@u .7.    L                   rBBMM8OO@B@BS rEqqOB:  ....    ....             MBv:,2i                                      
                          BME   7r  .7                    GPSSNGOZ@B@B@@@ZP0BB1                         :@v27rvY                                      
                         rBMM    ,v,:.                       ,.,...:7SM@@@BB0OB@,                       B@iLNL:1.                                     
                          FB@.     :N.                  .   .::.,..     iYqB@B8B@L                     E@v77Lr:7L                                     
                           @Bu      7ir.           ..,..       .           @@@E0Z@@J                  :@k77vLL:iU                                     
                           MBM     i: .ri      .,,:.                      @B@rXBOEOB@S:               @8J7vvJui:Lr                                    
                          :@M@:    v     :  ,::,                        .@B@M  L8@MGZBBMu,           @BuY77J;.;:i5                                    
                           2@BX    r    .,ii.                          .@B@B:   .rXM@O8O@BM2:      .@BjUL7vLL:1i:Yi                                   
                             @Br  .: :i:,  7                          :@@@BF .     :vqO@MMM@B@BOF7L@BYu17v772G07:rv                                   
                             L@B. ;i:      7                         i@B@BB ,         :;uPMM@B@B@B@MFPq2vvLvvvLLi:L                                   
                             7BMO:r7...    i,                  .    7@NPB@..             ..:rFqPB@7 ,2kk15UUJYLj7iiL                                  
                             L@MMG7v  .:ri:ir                ..    2@EN8@: ,               .,   .   i.  :i7Lu5Xk0Yr0E.,                               
                              jMOOO@:      :2ii:           ,.     @@MO@M, :               .:   ,   7.    .  ,   .7L:L:.:,                             
                                vBE8B       7  ,;rr:.    ::        U@B5 .:               ,7   :   r     i   i     L  ..  .:                           
                                 EOZMX      i,     .:ii:,            .                    ,;::   ,     ::  :.     i:  .. ,.                           
                                 1@M8B8     ,r       :i:,                     .             :iii       :   i       r  .  i                            
                                  uZBMBB     J     i;.  v                   ,.              ,   ::.   :    ,     . :   , .i                           
                                    rBMM@i   v   :7,    .7                .:               .:     ,::iv.  ,   .  ,      u:                            
                                     v@@B@1  ::.i,       v               ::                i          .iiir:i;ri.r;.:iir, .                           
                                      :ruB@0  7:  .....  .j            .r.                :               ::. . . .i.      :                          
                                         YB@MuuE:  .,::i::uv:;ii::.   ii                 ,,               i:       r.    ,  :                         
                                           M@MMMBr         Y    ...:7J,                  :               .r,       ;:     .  :                        
                                          ..Y@8EE@M7       7:      ii ,.                :                i:.       ii.       .:                       
                                         ::  .@BEqOBMr      2    :v:   :i              ..                r:        ,r,     .  .:                      
                                        ,r    .2BGqE8@ML    :i ,ir      .r             :                .7:         r:         ,,                     
                                        i       :PPSXPG@@Nr  v,::        .Y,......... ,                 ,,.         :,          .                     


***************************/

#include <cstdio>
#include <cstdlib>
#include <cstring>
#include <iostream>
#include <string>
#include <sstream>
#include <fstream>
#include <algorithm>
#include <WinSock2.h>
#include <process.h>
#include "Thread.h"
namespace WebServ {

	class WebServer : public Thread::Thread {
	private:
		const static int BUF_SIZE = 2048;
		const static int BUF_SMALL = 100;

		struct THREAD_DATA {
			WebServer* h;
			SOCKET s;
		};

		static unsigned WINAPI agent(void *arg) {
			WebServer *p = ((THREAD_DATA*)arg)->h;
			SOCKET s = ((THREAD_DATA*)arg)->s;
			return p->RequestHandler((void*)s);
		}

		// 必须终止程序的严重错误
		void ErrorHandling(char* message) {
			using namespace std;
			cerr << message << endl;
			exit(1);
		}
		
		unsigned RequestHandler(void *arg) {
			SOCKET hClntSock = (SOCKET)arg;
			char buf[BUF_SIZE];
			char method[BUF_SMALL];
			char ct[BUF_SMALL];
			char fileName[BUF_SMALL];
			char* pNext;

			int len = recv(hClntSock, buf, BUF_SIZE, 0);
			buf[len] = 0;
			printf("收到信息：\n%s\n", buf);
			if (strstr(buf, "HTTP/") == NULL) {
				SendErrorMSG(hClntSock);
				closesocket(hClntSock);
				return 1;
			}
			strcpy_s(method, BUF_SMALL, strtok_s(buf, " /", &pNext));
			if (strcmp(method, "GET")) SendErrorMSG(hClntSock);
			strcpy_s(fileName, BUF_SMALL, strtok_s(NULL, " /", &pNext));
			strcpy_s(ct, BUF_SMALL, ContentType(fileName));
			printf("GET方法\nfileName: %s\nct: %s\n", fileName, ct);
			SendData(hClntSock, ct, fileName);
			return 0;
		}

	protected:
		// 禁止拷贝
		WebServer(){}
		WebServer(const WebServer&);
		WebServer& operator=(const WebServer&);
	public:
		// 单例模式
		static WebServer* Instance() {
			static WebServer _instance;
			return &_instance;
		}

		// 开始服务
		int Start(char hostport[]) {
			int port = atoi(hostport);
			return Start(port);
		}

		// 开始服务
		int Start(int hostport) {
			WSADATA wsaData;
			SOCKET hServSock, hClntSock;
			SOCKADDR_IN servAdr, clntAdr;

			HANDLE hThread;
			DWORD dwThreadID;
			int clntAdrSize;

			THREAD_DATA dat;
			dat.h = this;
			dat.s = hClntSock;

			if (WSAStartup(MAKEWORD(2, 2), &wsaData) != 0) ErrorHandling("WSAStartup error");
			printf("WinSock库初始化完毕\n");
			hServSock = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP);
			memset(&servAdr, 0, sizeof(servAdr));
			servAdr.sin_family = AF_INET;
			servAdr.sin_addr.S_un.S_addr = htonl(INADDR_ANY);
			servAdr.sin_port = htons(hostport);

			if (bind(hServSock, (SOCKADDR*)&servAdr, sizeof(servAdr)) == SOCKET_ERROR) ErrorHandling("bind error");
			if (listen(hServSock, 5) == SOCKET_ERROR) ErrorHandling("listen error");
			printf("开始监听连接...\n");
			for (;;) {
				clntAdrSize = sizeof(clntAdr);
				hClntSock = accept(hServSock, (SOCKADDR*)&clntAdr, &clntAdrSize);
				printf("Connection Request : %s:%d\n", inet_ntoa(clntAdr.sin_addr), ntohs(clntAdr.sin_port));
				hThread = (HANDLE)_beginthreadex(NULL, 0, agent, (void*)&dat, 0, (unsigned*)&dwThreadID);
			}
			closesocket(hServSock);
			WSACleanup();
			return 0;
		}

	};
}
	/*
	const int BUF_SIZE = 2048;
	const int BUF_SMALL = 100;
	unsigned WINAPI RequestHandler(void* arg);
	char* ContentType(char* file);
	void SendData(SOCKET sock, char* ct, char* fileNmae);
	void SendErrorMSG(SOCKET sock);
	void ErrorHandling(char* message);

	int Start(char hostport[]) {
		WSADATA wsaData;
		SOCKET hServSock, hClntSock;
		SOCKADDR_IN servAdr, clntAdr;

		HANDLE hThread;
		DWORD dwThreadID;
		int clntAdrSize;

		if (WSAStartup(MAKEWORD(2, 2), &wsaData) != 0) ErrorHandling("WSAStartup error");
		printf("WinSock库初始化完毕\n");
		hServSock = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP);
		memset(&servAdr, 0, sizeof(servAdr));
		servAdr.sin_family = AF_INET;
		servAdr.sin_addr.S_un.S_addr = htonl(INADDR_ANY);
		servAdr.sin_port = htons(atoi(hostport));

		if (bind(hServSock, (SOCKADDR*)&servAdr, sizeof(servAdr)) == SOCKET_ERROR) ErrorHandling("bind error");
		if (listen(hServSock, 5) == SOCKET_ERROR) ErrorHandling("listen error");
		printf("开始监听连接...\n");
		for (;;) {
			clntAdrSize = sizeof(clntAdr);
			hClntSock = accept(hServSock, (SOCKADDR*)&clntAdr, &clntAdrSize);
			printf("Connection Request : %s:%d\n", inet_ntoa(clntAdr.sin_addr), ntohs(clntAdr.sin_port));
			hThread = (HANDLE)_beginthreadex(NULL, 0, RequestHandler, (void*)hClntSock, 0, (unsigned*)&dwThreadID);
		}
		closesocket(hServSock);
		WSACleanup();
		return 0;
	}

	unsigned WINAPI RequestHandler(void *arg) {
		SOCKET hClntSock = (SOCKET)arg;
		char buf[BUF_SIZE];
		char method[BUF_SMALL];
		char ct[BUF_SMALL];
		char fileName[BUF_SMALL];
		char* pNext;

		int len = recv(hClntSock, buf, BUF_SIZE, 0);
		buf[len] = 0;
		printf("收到信息：\n%s\n", buf);
		if (strstr(buf, "HTTP/") == NULL) {
			SendErrorMSG(hClntSock);
			closesocket(hClntSock);
			return 1;
		}
		strcpy_s(method, BUF_SMALL, strtok_s(buf, " /", &pNext));
		if (strcmp(method, "GET")) SendErrorMSG(hClntSock);
		strcpy_s(fileName, BUF_SMALL, strtok_s(NULL, " /", &pNext));
		strcpy_s(ct, BUF_SMALL, ContentType(fileName));
		printf("GET方法\nfileName: %s\nct: %s\n", fileName, ct);
		SendData(hClntSock, ct, fileName);
		return 0;
	}

	void SendData(SOCKET sock, char* ct, char* fileName) {
		char protocol[] = "HTTP/1.0 200 OK\r\n";
		char servName[] = "Server:simple web server\r\n";
		char cntLen[] = "Content-length:2048\r\n";
		char cntType[BUF_SMALL];
		char buf[BUF_SIZE];
		FILE* sendFile;

		sprintf_s(cntType, "Content-type:%s\r\n\r\n", ct);
		if ((fopen_s(&sendFile, fileName, "r")) != NULL) {
			SendErrorMSG(sock);
			return;
		}
		printf("开始发送信息...\n");
		send(sock, protocol, strlen(protocol), 0);
		send(sock, servName, strlen(servName), 0);
		send(sock, cntLen, strlen(cntLen), 0);
		send(sock, cntType, strlen(cntType), 0);

		while (fgets(buf, BUF_SIZE, sendFile) != NULL) send(sock, buf, strlen(buf), 0);

		closesocket(sock);
	}

	void SendErrorMSG(SOCKET sock) {
		printf("发生错误！\n");
		char protocol[] = "HTTP/1.0 404 Not Found\r\n";
		char servName[] = "Server:simple web server\r\n";
		char cntLen[] = "Content-length:2048\r\n";
		char cntType[] = "Content-type:text/html\r\n\r\n";
		char content[] = "<html><head><title>NETWORK</title></head>"
			"<body><font size=+5><br> 发生错误！查看请求文件名和请求方式！"
			"</font></body></html>";
		send(sock, protocol, strlen(protocol), 0);
		send(sock, servName, strlen(servName), 0);
		send(sock, cntLen, strlen(cntLen), 0);
		send(sock, cntType, strlen(cntType), 0);
		send(sock, content, strlen(content), 0);
		closesocket(sock);
	}

	char* ContentType(char* file) {
		char extension[BUF_SMALL];
		char fileName[BUF_SMALL];
		char* pNext;
		strcpy_s(fileName, BUF_SMALL, file);
		strtok_s(fileName, ".", &pNext);
		strcpy_s(extension, BUF_SMALL, strtok_s(NULL, ".", &pNext));
		if (!strcmp(extension, "html") || !strcmp(extension, "htm")) return "text/html";
		else return "text/plain";
	}

	void ErrorHandling(char* message) {
		fputs(message, stderr);
		fputc('\n', stderr);
		exit(1);
	}

}

#include <winsock.h>
#include <sys/stat.h>
#include <iostream>
using namespace std;
#define SERVER_PORT 10000         //自定义的服务端口
#define HOSTLEN 256           //主机名长度
#define BACKLOG 10           //同时等待的连接个数

int sendall(int s, char *buf, int *len) {
	int total = 0;           // 已经发送字节数
	int bytesleft = *len;                                   //还剩余多少字节
	int n;
	while (total < *len) {
		n = send(s, buf + total, bytesleft, 0);
		if (n == -1) { break; }
		total += n;
		bytesleft -= n;
	}
	*len = total;           // 返回实际发送出去的字节数
	return n == -1 ? -1 : 0;          // 成功发送返回0 失败-1
}

void wrong_req(int sock) {
	char* error_head = "HTTP/1.0 501 Not Implemented\r\n"; //输出501错误
	int len = strlen(error_head);
	if (sendall(sock, error_head, &len) == -1) {   //向客户发送
		printf("Sending failed!");
		return;
	}
	char* error_type = "Content-type: text/plain\r\n";
	len = strlen(error_type);
	if (sendall(sock, error_type, &len) == -1) {
		printf("Sending failed!");
		return;
	}
	char* error_end = "\r\n";
	len = strlen(error_end);
	if (sendall(sock, error_end, &len) == -1) {
		printf("Sending failed!");
		return;
	}
	char* prompt_info = "The command is not yet completed\r\n";
	len = strlen(prompt_info);
	if (sendall(sock, prompt_info, &len) == -1) {
		printf("Sending failed!");
		return;
	}
}

bool not_exit(char* arguments) {
	struct stat dir_info;
	return (stat(arguments, &dir_info) == -1);
}

void file_not_found(char* arguments, int sock) {
	char* error_head = "HTTP/1.0 404 Not Found\r\n";   //构造404错误head
	int len = strlen(error_head);
	if (sendall(sock, error_head, &len) == -1) {    //向客户端发送
		printf("Sending error!");
		return;
	}
	char* error_type = "Content-type: text/plain\r\n";
	len = strlen(error_type);
	if (sendall(sock, error_type, &len) == -1) {
		printf("Sending error!");
		return;
	}
	char* error_end = "\r\n";
	len = strlen(error_end);
	if (sendall(sock, error_end, &len) == -1) {
		printf("Sending error!");
		return;
	}
	char prompt_info[50] = "Not found:  ";
	strcat(prompt_info, arguments);
	len = strlen(prompt_info);
	if (sendall(sock, prompt_info, &len) == -1) {    //输出未找到的文件
		printf("Sending error!");
		return;
	}
}

void send_header(int send_to, char* content_type) {

	char* head = "HTTP/1.0 200 OK\r\n";     //正确的头部信息
	int len = strlen(head);
	if (sendall(send_to, head, &len) == -1) {   //向连接的客户端发送数据
		printf("Sending error");
		return;
	}
	if (content_type) {         //content_type不为空
		char temp_1[30] = "Content-type: ";    //准备好要连接的字串
		strcat(temp_1, content_type);     //构造content_type
		strcat(temp_1, "\r\n");
		len = strlen(temp_1);
		if (sendall(send_to, temp_1, &len) == -1) {
			printf("Sending error!");
			return;
		}
	}
}

char* file_type(char* arg) {
	char * temp;          //临时字符串指针
	if ((temp = strrchr(arg, '.')) != NULL) {    //取得后缀
		return temp + 1;
	}
	return "";           //如果请求的文件名中没有. 则返回空串
}

void send_file(char* arguments, int sock) {
	char* extension = file_type(arguments);    //获得文件后缀名
	char* content_type = "text/plain";     //初始化type='text/plain'
	FILE* read_from;         //本地文件指针 从该文件中读取.html .jpg等
	int readed = -1;         //每次读得的字节数

	if (strcmp(extension, "html") == 0) {    //发送内容为html
		content_type = "text/html";
	}
	if (strcmp(extension, "gif") == 0) {    //发送内容为gif
		content_type = "image/gif";
	}
	if (strcmp(extension, "jpg") == 0) {    //发送内容为jpg
		content_type = "image/jpg";
	}
	read_from = fopen(arguments, "r");     //打开用户指定的文件 准备读取
	if (read_from != NULL) {        //指针不为空
		char read_buf[128];        //读文件时的字节缓存数组
		send_header(sock, content_type);    //发送协议头
		send(sock, "\r\n", 2, 0);      //再加一个"\r\n" 不能缺少 格式要求
		while (!feof(read_from)) {      //判断文件是否已经结束
			fgets(read_buf, 128, read_from);   //读取
			int len = strlen(read_buf);
			if (sendall(sock, read_buf, &len) == -1) { //发送数据
				printf("Sending error!");    //出现发送错误 显示到控制台 继续发送
				continue;
			}
		}
	}
}

void handle_req(char* request, int client_sock) {
	char command[BUFSIZ];        //保存解析到的命令字段 GET PUT
	char arguments[BUFSIZ];        //保存解析到的请求的文件

	strcpy(arguments, "./");       //注意该符号在不同操作系统的区别

	if (sscanf(request, "%s%s", command, arguments + 2) != 2) {
		return;           //解析出错在返回
	}

	printf("handle_cmd:    %s\n", command);    //向控制台输出此时的命令
	printf("handle_path:   %s\n", arguments);   //向控制台输出此时的请求路径

	if (strcmp(command, "GET") != 0) {     //请求命令格式是否正确
		wrong_req(client_sock);
		return;
	}
	if (not_exit(arguments)) {       //请求的文件是否存在  
		file_not_found(arguments, client_sock);
		return;
	}
	send_file(arguments, client_sock);     //命令格式及请求路径正确则发送数据

	return;
}

int make_server_socket() {
	struct sockaddr_in server_addr;       //服务器地址结构体
	int tempSockId;           //临时存储socket描述符
	tempSockId = socket(PF_INET, SOCK_STREAM, 0);

	if (tempSockId == -1) {         //如果返回值为－1 则出错
		return -1;
	}

	server_addr.sin_family = AF_INET;
	server_addr.sin_port = htons(SERVER_PORT);
	server_addr.sin_addr.s_addr = inet_addr("127.0.0.1");  //本地地址
	memset(&(server_addr.sin_zero), '\0', 8);
	if (bind(tempSockId, (struct sockaddr *)&server_addr,
		sizeof(server_addr)) == -1) {       //绑定服务 如果出错 则返回－1
		printf("bind error!\n");
		return -1;
	}
	if (listen(tempSockId, BACKLOG) == -1) {     //开始监听
		printf("listen error!\n");
		return -1;
	}
	return tempSockId;           //返回取得的SOCKET
}

void main(int argc, char * argv[]) {

	WSADATA wsaData;
	if (WSAStartup(MAKEWORD(1, 1), &wsaData) != 0) {
		fprintf(stderr, "WSAStartup failed.\n");
		exit(1);
	}
	printf("My web server started...\n");
	int server_socket;        //服务器的socket
	int acc_socket;         //接收到的用户连接的socket
	int sock_size = sizeof(struct sockaddr_in);
	struct sockaddr_in user_socket;     //客户连接信息
	server_socket = make_server_socket();   //创建服务器端的socket
	if (server_socket == -1) {      //创建socket出错
		printf("Server exception!\n");
		exit(2);
	}

	while (true) {
		acc_socket = accept(server_socket, (struct sockaddr *)&user_socket, &sock_size); //接收连接

		//cout << inet_ntoa(user_socket.sin_addr) << endl;    //测试用:-)//


		int numbytes;
		char buf[100];
		if ((numbytes = recv(acc_socket, buf, 99, 0)) == -1) {
			perror("recv");
			exit(1);
		}

		//printf("buf ... %s", buf);      //测试用

		handle_req(buf, acc_socket);
	}
}

*/